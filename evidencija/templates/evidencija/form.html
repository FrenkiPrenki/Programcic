<!doctype html>
<html lang="hr">

<head>
  <meta charset="utf-8">
  <title>{{ title }}</title>
  <style>
    body {
      font-family: system-ui, Arial, sans-serif;
      margin: 24px;
    }

    form {
      max-width: 720px;
    }

    label {
      display: block;
      margin-top: 12px;
      font-weight: 600;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    .muted {
      color: #666;
      font-size: 12px;
    }

    button,
    a.btn {
      background: #222;
      color: #fff;
      padding: 10px 14px;
      border: none;
      border-radius: 8px;
      margin-top: 16px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }

    a.btn.light {
      background: #eee;
      color: #222;
    }
  </style>
</head>

<body>
  <h1>{{ title }}</h1>
  <form method="post">
    {% csrf_token %}
    {{ form.non_field_errors }}
    {% for field in form %}
    <label for="{{ field.id_for_label }}">{{ field.label }}</label>
    {{ field }}
    {% if field.help_text %}<div class="muted">{{ field.help_text }}</div>{% endif %}
    {% for e in field.errors %}<div style="color:#b80000">{{ e }}</div>{% endfor %}
    {% endfor %}
    <div>
      <button type="submit">Spremi</button>
      <a class="btn light" href="javascript:history.back()">Odustani</a>
    </div>
  </form>
  {% if is_dopis_form %}
  {% if is_dopis_form %}
  <script>
    (function () {
      // nađi polja po "name" (robustno, ne ovisi o id-u)
      const kat = document.querySelector('[name="kategorija"]');
      const broj = document.querySelector('[name="broj_int"], [name="broj"]');

      console.log("AUTO-BROJ init:", { katFound: !!kat, brojFound: !!broj });

      if (!kat || !broj) return;

      async function refreshBroj() {
        const k = (kat.value || "").trim();
        console.log("AUTO-BROJ change kategorija =", k);

        if (!k) return;

        const baseUrl = "{% url 'next_broj_for_kategorija' gradiliste.id %}";
        const url = baseUrl + "?kategorija=" + encodeURIComponent(k);

        console.log("AUTO-BROJ fetch:", url);

        try {
          const res = await fetch(url, { headers: { "Accept": "application/json" } });
          console.log("AUTO-BROJ response:", res.status, res.headers.get("content-type"));

          const text = await res.text();
          console.log("AUTO-BROJ body:", text.slice(0, 200));

          // pokušaj parsirati JSON
          let data;
          try { data = JSON.parse(text); } catch (e) { return; }

          if (!broj.value) {
            broj.value = data.next || "";
          }
        } catch (e) {
          console.log("AUTO-BROJ error:", e);
        }
      }

      kat.addEventListener("change", refreshBroj);

      // ako je kategorija već odabrana kad se forma učita
      refreshBroj();
    })();
  </script>
  {% endif %}
</body>

</html>