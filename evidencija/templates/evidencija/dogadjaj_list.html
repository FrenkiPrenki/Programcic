<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8">
  <title>Događaji</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <style>
    .table-compact td, .table-compact th { padding: .35rem .5rem; vertical-align: middle; }
    .truncate { max-width: 460px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .nowrap { white-space: nowrap; }
    td.nowrap span {white-space: nowrap; }
    .actions { display: flex; flex-wrap: nowrap; gap: .4rem; align-items: center; }
    .btn.btn-sm { padding: .15rem .4rem; line-height: 1.1; }
    </style>
</head>
<body class="container-fluid my-4">

  <h1 class="mb-4">Događaji</h1>

  <!-- Toolbar -->
  <div class="d-flex flex-wrap align-items-center mb-3 gap-2">
    <div class="text-muted">Danas: {{ today }}</div>

    <div class="ms-3">
      <strong>Sortiraj događaje:</strong>
      <a href="?sort=broj_asc&d_sort={{ d_sort }}" class="btn btn-sm {% if sort == 'broj_asc' %}btn-dark{% else %}btn-outline-dark{% endif %}">Broj ↑</a>
      <a href="?sort=broj_desc&d_sort={{ d_sort }}" class="btn btn-sm {% if sort == 'broj_desc' %}btn-dark{% else %}btn-outline-dark{% endif %}">Broj ↓</a>
      <a href="?sort=datum_desc&d_sort={{ d_sort }}" class="btn btn-sm {% if sort == 'datum_desc' %}btn-dark{% else %}btn-outline-dark{% endif %}">Datum ↓</a>
      <a href="?sort=datum_asc&d_sort={{ d_sort }}" class="btn btn-sm {% if sort == 'datum_asc' %}btn-dark{% else %}btn-outline-dark{% endif %}">Datum ↑</a>
    </div>

    <div class="ms-3">
      <strong>Sortiraj dopise:</strong>
      <a href="?sort={{ sort }}&d_sort=poslano_asc" class="btn btn-sm {% if d_sort == 'poslano_asc' %}btn-dark{% else %}btn-outline-dark{% endif %}">Poslano ↑</a>
      <a href="?sort={{ sort }}&d_sort=poslano_desc" class="btn btn-sm {% if d_sort == 'poslano_desc' %}btn-dark{% else %}btn-outline-dark{% endif %}">Poslano ↓</a>
      <a href="?sort={{ sort }}&d_sort=broj_asc" class="btn btn-sm {% if d_sort == 'broj_asc' %}btn-dark{% else %}btn-outline-dark{% endif %}">Broj ↑</a>
      <a href="?sort={{ sort }}&d_sort=broj_desc" class="btn btn-sm {% if d_sort == 'broj_desc' %}btn-dark{% else %}btn-outline-dark{% endif %}">Broj ↓</a>    
    </div>

    <div class="ms-auto d-flex gap-2">
      <a class="btn btn-outline-secondary"
        href="{% url 'gradilista_list' %}">
        ← Gradilišta
      </a>

      <a class="btn btn-success"
        href="{% url 'dogadjaj_create' gradiliste.id %}">
        + Novi događaj
      </a>

      <a class="btn btn-secondary"
        href="/admin/">
        Admin
      </a>

      <a class="btn btn-outline-primary"
        href="/gradilista/{{ gradiliste.id }}/dopisi/?kategorija=ZZI">
        Dopisi
      </a>
    </div>
  </div>

  <!-- Glavna tablica -->
  <table class="table table-striped table-sm table-compact align-middle w-100">
    <thead class="table-dark">
      <tr>
        <th style="width:90px;">Br.</th>
        <th class="truncate">Naziv</th>
        <th style="width:260px;">Preporučena radnja</th>
        <th style="width:160px;" class="nowrap">Datum</th>
        <th style="width:160px;" class="nowrap">Zadnji dopis</th>
        <th style="width:260px;">Akcije</th>
      </tr>
    </thead>
    <tbody>
      {% for dogadjaj, dopisi, ball_on_us, last, event_cls in rows %}
      <tr class="{{ event_cls }}">
        <td class="nowrap">{{ dogadjaj.broj }}</td>
        <td class="truncate">
          <a href="{% url 'dogadjaj_detail' gradiliste.id dogadjaj.pk %}" class="text-decoration-none">
            {{ dogadjaj.naziv }}
          </a>
        </td>
        <td class="nowrap">{{ dogadjaj.get_preporucena_radnja_display }}</td>
        <td style="white-space: nowrap;">
          {{ dogadjaj.datum|date:"d.m.Y" }}
        </td>
        <td style="white-space: nowrap;">
          {% if last %}{{ last.poslano|date:"d.m.Y" }}{% else %}-{% endif %}
        </td>
        <td class="nowrap">
          <div class="actions">
            <button class="btn btn-sm btn-primary" onclick="toggle('d-{{ dogadjaj.id }}')">
              Dopisi ({{ dopisi|length }})
            </button>
            <a class="btn btn-sm btn-success" href="{% url 'dopis_create_for_event' gradiliste.id dogadjaj.id %}">+ Dopis</a>
            <a class="btn btn-sm btn-warning" href="{% url 'dogadjaj_update' gradiliste.id dogadjaj.id %}">Uredi</a>
          </div>
        </td>
      </tr>
      <!-- skriveni red sa dopisima (ostaje kako je) -->
      <tr id="d-{{ dogadjaj.id }}" style="display:none;">
        <td colspan="6">
          {% if dopisi %}
          <table class="table table-sm table-bordered mt-2">
            <thead class="table-light">
              <tr>
                <th>Broj</th>
                <th>Vrsta</th>
                <th>Poslano</th>
                <th>Razuman rok</th>
                <th>Status</th>
                <th>Napomena</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for dopis, cls, label in dopisi %}
              <tr class="{{ cls }}">
                <td>{{ dopis.prikaz_broja }}</td>
                <td>{{ dopis.get_vrsta_display }}</td>
                <td>{{ dopis.poslano|default:"—" }}</td>
                <td>
                  {% if dopis.razuman_rok %}
                    <span class="badge bg-secondary">{{ label }}</span><br>
                    <small class="text-muted">{{ dopis.razuman_rok }}</small>
                  {% else %} — {% endif %}
                </td>
                <td>{{ dopis.get_status_display }}</td>
                <td class="text-muted">{{ dopis.sadrzaj|truncatechars:120 }}</td>
                <td><a class="btn btn-sm btn-outline-primary" href="{% url 'dopis_update' gradiliste.id dopis.id %}">Otvori</a></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
            <div class="text-muted">Nema dopisa za ovaj događaj.</div>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="6">Još nema događaja.</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <script>
    function toggle(id) {
      const el = document.getElementById(id);
      el.style.display = (el.style.display === 'none' || !el.style.display) ? 'table-row' : 'none';
    }
  </script>
</body>
</html>
